name: Auto-update site (sitemap, index, schema & Google ping)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          BASE_URL="https://insoumisseineetloing.github.io/piqure-de-rappel"
          PDF_DIR="pdfs"
          INDEX_FILE="index.html"
          SCHEMA_FILE="article-schema.json"
          SITEMAP_FILE="sitemap.xml"
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "PDF_DIR=$PDF_DIR" >> $GITHUB_ENV
          echo "INDEX_FILE=$INDEX_FILE" >> $GITHUB_ENV
          echo "SCHEMA_FILE=$SCHEMA_FILE" >> $GITHUB_ENV
          echo "SITEMAP_FILE=$SITEMAP_FILE" >> $GITHUB_ENV

      - name: Update index, schema and sitemap
        run: |
          echo "=== Reconstruction complète du bloc PDF ==="
          cd $GITHUB_WORKSPACE

          # Trouve tous les fichiers PDF (majuscules ou minuscules)
          PDF_LIST=$(find "$PDF_DIR" -type f \( -iname "*.pdf" ! -name ".keep" \) | sort)

          if [ -z "$PDF_LIST" ]; then
            echo "⚠️ Aucun PDF trouvé dans le dossier $PDF_DIR"
            exit 0
          fi

          # Supprime l'ancien bloc <h2>Numéros disponibles ... </ul>
          sed -i '/<h2>Numéros disponibles :<\/h2>/,/<\/ul>/d' "$INDEX_FILE"

          # Reconstruit le bloc complet
          {
            echo '<h2>Numéros disponibles :</h2>'
            echo '<ul>'
            while IFS= read -r pdf; do
              name=$(basename "$pdf" .pdf)

              # Si le nom correspond à N001_2023-01
              if [[ "$name" =~ ^N([0-9]{3})_([0-9]{4})-([0-9]{2})$ ]]; then
                num="${BASH_REMATCH[1]}"
                year="${BASH_REMATCH[2]}"
                month="${BASH_REMATCH[3]}"

                case "$month" in
                  01) m="Janvier" ;; 02) m="Février" ;; 03) m="Mars" ;; 04) m="Avril" ;;
                  05) m="Mai" ;; 06) m="Juin" ;; 07) m="Juillet" ;; 08) m="Août" ;;
                  09) m="Septembre" ;; 10) m="Octobre" ;; 11) m="Novembre" ;; 12) m="Décembre" ;;
                esac

                title="Numéro $((10#$num)) – $m $year"
              else
                # Si c’est un nom libre (ex: Tract_Meeting.pdf)
                title="${name//_/ }"
              fi

              echo "  <li><a href=\"$pdf\" target=\"_blank\">$title</a></li>"
            done <<< "$PDF_LIST"
            echo '</ul>'
          } >> "$INDEX_FILE"

          echo "✅ Bloc PDF régénéré avec succès"

          # Met à jour schema.json
          echo "[" > "$SCHEMA_FILE"
          while IFS= read -r pdf; do
            name=$(basename "$pdf")
            [[ "$name" == ".keep" ]] && continue
            echo "  {\"@type\": \"CreativeWork\", \"name\": \"$name\", \"url\": \"$BASE_URL/$pdf\"}," >> "$SCHEMA_FILE"
          done <<< "$PDF_LIST"
          sed -i '$ s/,$//' "$SCHEMA_FILE"
          echo "]" >> "$SCHEMA_FILE"

          echo "✅ Schéma JSON mis à jour"

          # Met à jour sitemap.xml
          echo '<?xml version="1.0" encoding="UTF-8"?>' > "$SITEMAP_FILE"
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> "$SITEMAP_FILE"
          while IFS= read -r pdf; do
            name=$(basename "$pdf")
            [[ "$name" == ".keep" ]] && continue
            echo "  <url><loc>$BASE_URL/$pdf</loc><priority>0.7</priority></url>" >> "$SITEMAP_FILE"
          done <<< "$PDF_LIST"
          echo "  <url><loc>$BASE_URL/</loc><priority>1.0</priority></url>" >> "$SITEMAP_FILE"
          echo '</urlset>' >> "$SITEMAP_FILE"

          echo "✅ Sitemap mis à jour"

      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html article-schema.json sitemap.xml || true
          git commit -m "Auto-update index, sitemap & schema" || echo "Aucun changement à committer"
          git push origin main || echo "Rien à pousser"

      - name: Ping Google for sitemap refresh
        run: |
          curl -X GET "https://www.google.com/ping?sitemap=https://insoumisseineetloing.github.io/piqure-de-rappel/sitemap.xml"
