name: Auto-update site (clean single list)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate single list
        run: |
          INDEX_FILE="index.html"
          PDF_DIR="pdfs"

          # Supprime seulement les anciens blocs de liste
          sed -i '/<h2>Numéros disponibles/,/<\/ul>/d' "$INDEX_FILE"

          {
            echo '<h2 style="color:#b50000; text-align:left; font-size:20px; font-weight:bold; margin-top:30px;">Numéros disponibles :</h2>'
            echo '<ul style="list-style:none; padding-left:0; margin-top:10px;">'
            for FILE in $(ls "$PDF_DIR"/*.pdf | sort -V); do
              BASENAME=$(basename "$FILE")
              if [[ $BASENAME =~ ^N([0-9]+)_([0-9]{4})-([0-9]{2})\.pdf$ ]]; then
                NUM=$(echo "${BASH_REMATCH[1]}" | sed 's/^0*//')
                YEAR="${BASH_REMATCH[2]}"
                MONTH="${BASH_REMATCH[3]}"
                case $MONTH in
                  01) M="Janvier";;02) M="Février";;03) M="Mars";;04) M="Avril";;
                  05) M="Mai";;06) M="Juin";;07) M="Juillet";;08) M="Août";;
                  09) M="Septembre";;10) M="Octobre";;11) M="Novembre";;12) M="Décembre";;
                esac
                echo "  <li style='margin-bottom:5px; text-align:left; font-size:16px;'><a href='pdfs/$BASENAME' target='_blank' style='color:#0000cc; text-decoration:none;'>Numéro $NUM – $M $YEAR</a></li>"
              fi
            done
            echo '</ul>'
          } > new.html

          # Insère la liste juste avant le bloc footer (sans le réécrire)
          awk 'BEGIN{done=0} /<div style="text-align:center; margin-top:40px;">/{system("cat new.html"); done=1} {print} END{if(done==0) system("cat new.html")}' "$INDEX_FILE" > tmp && mv tmp "$INDEX_FILE"

          rm new.html

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add index.html
          git commit -m "Clean index and rebuild single list" || echo "No changes"
          git push
