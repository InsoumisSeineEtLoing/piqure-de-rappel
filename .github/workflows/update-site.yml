name: Auto-update site (smart index titles + sitemap + Google ping)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Clean and update index.html
        run: |
          INDEX_FILE="index.html"
          PDF_DIR="pdfs"

          echo "🔍 Scan des fichiers PDF..."
          FILES=$(ls "$PDF_DIR"/*.pdf 2>/dev/null || true)

          # Nettoyage complet des anciens blocs et footer
          sed -i '/<h2>Numéros disponibles *:<\/h2>/,/<\/ul>/d' "$INDEX_FILE"
          sed -i '/À propos/d' "$INDEX_FILE"
          sed -i '/Contact/d' "$INDEX_FILE"
          sed -i '/© 2017/d' "$INDEX_FILE"
          sed -i '/^ *| *$/d' "$INDEX_FILE"

          # Crée la nouvelle liste
          {
            echo '<h2 style="color:#b50000; text-align:left; font-size:20px; font-weight:bold; margin-top:30px;">Numéros disponibles :</h2>'
            echo '<ul style="list-style:none; padding-left:0; margin-top:10px;">'

            for FILE in $(ls "$PDF_DIR"/*.pdf | sort -V); do
              BASENAME=$(basename "$FILE")

              if [[ $BASENAME =~ ^N([0-9]+)_([0-9]{4})-([0-9]{2})\.pdf$ ]]; then
                NUM=$(echo "${BASH_REMATCH[1]}" | sed 's/^0*//')
                YEAR="${BASH_REMATCH[2]}"
                MONTH="${BASH_REMATCH[3]}"

                case $MONTH in
                  01) MONTH_NAME="Janvier" ;;
                  02) MONTH_NAME="Février" ;;
                  03) MONTH_NAME="Mars" ;;
                  04) MONTH_NAME="Avril" ;;
                  05) MONTH_NAME="Mai" ;;
                  06) MONTH_NAME="Juin" ;;
                  07) MONTH_NAME="Juillet" ;;
                  08) MONTH_NAME="Août" ;;
                  09) MONTH_NAME="Septembre" ;;
                  10) MONTH_NAME="Octobre" ;;
                  11) MONTH_NAME="Novembre" ;;
                  12) MONTH_NAME="Décembre" ;;
                esac

                echo "  <li style=\"margin-bottom:5px; text-align:left; font-size:16px;\"><a href=\"pdfs/$BASENAME\" target=\"_blank\" style=\"color:#0000cc; text-decoration:none;\">Numéro $NUM – $MONTH_NAME $YEAR</a></li>"
              fi
            done

            echo '</ul>'
          } > new_block.html

          # Insertion unique avant </footer>
          awk 'BEGIN{inserted=0}
               /<\/footer>/{system("cat new_block.html"); inserted=1}
               {print}
               END{if(inserted==0) system("cat new_block.html")}' "$INDEX_FILE" > tmp && mv tmp "$INDEX_FILE"

          rm new_block.html

          # Ajout du pied de page correct
          {
            echo ''
            echo '<div style="text-align:center; margin-top:40px;">'
            echo '<p style="color:#b50000; font-weight:bold; font-size:14px;">'
            echo '<a href="about.html" style="color:#b50000; text-decoration:none;">À propos</a> | <a href="contact.html" style="color:#b50000; text-decoration:none;">Contact</a>'
            echo '</p>'
            echo '<p style="color:#5a3d3d; font-size:12px; margin-top:10px; font-family:sans-serif;">© 2017 – Groupe d’Action Insoumis·es Seine & Loing</p>'
            echo '</div>'
          } >> "$INDEX_FILE"

          echo "✅ Page mise à jour proprement (un seul bloc, bon style, footer en bas)."

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add index.html
          git commit -m "Fix double list and footer layout" || echo "No changes to commit"
          git push origin main

      - name: Ping Google
        run: |
          curl "https://www.google.com/ping?sitemap=https://insoumisseineetloing.github.io/sitemap.xml"
